---
output:
  html_document:
    toc: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
Sys.Date()
```

Authors: Hanna Klimczak, Kamil Pluci≈Ñski

# Libraries used

```{r, message=FALSE}
library(plotly)
library(knitr)
library(kableExtra)
library(caret)
```


# Providing data reproductibility
To ensure that running the notebook will always return the same output, we set seed to 0.

```{r}
set.seed(0)
```

# Reading data from file

```{r, results='asis'}
data <- read.csv("Life_Expectancy_Data.csv")
kable(head(data), "html") %>% kable_styling("striped") %>% scroll_box(width = "100%")
```

# Dataset summary and basic statistics

```{r}
nrow(data)
```
```{r}
kable(summary(data), "html") %>% kable_styling("striped") %>% scroll_box(width = "100%")
```

# Dealing with missing values

As we can see from the summary above, there are some missing values in the dataset. Due to the fact that life.expectancy is the most important attribute for our analysis, we have decided to remove all rows where life.expectancy is NA.


```{r}
data_new <- data[complete.cases(data[ , 'Life.expectancy']),]
```

After this operation, we still encounter missing values in the following columns: "Alcohol", "Hepatitis.B", "BMI", "Polio", "Total.expenditure", "Diphtheria", "GDP", "Population", "thinness..1.19.years", "thinness.5.9.years", "Income.composition.of.resources", "Schooling". We will fill these NA values with median for each column.

```{r}
na_columns <- list("Alcohol", "Hepatitis.B", "BMI", "Polio", "Total.expenditure", "Diphtheria", "GDP", "Population", "thinness..1.19.years", "thinness.5.9.years", "Income.composition.of.resources", "Schooling")

for (col in na_columns){
    m <- median(data_new[ , col], na.rm=TRUE)
    print(col)
    print(m)
    data_new[ , col][is.na(data_new[ , col])] <- m
}
```
```{r}
kable(summary(data_new), "html") %>% kable_styling("striped") %>% scroll_box(width = "100%")
```

As we can see, we have successfully dealt with missing values.

# In-depth analysis of attributes (i.e. value distribution)

```{r}
names(data_new)
```
```{r, warning=FALSE}

quantitive_cols = c("Year", "Life.expectancy", "Adult.Mortality", "infant.deaths", "Alcohol", "percentage.expenditure", "Hepatitis.B", "Measles", "BMI", "under.five.deaths", "Polio", "Total.expenditure", "Diphtheria","HIV.AIDS","GDP","Population", "thinness..1.19.years","thinness.5.9.years",     "Income.composition.of.resources", "Schooling")

plots <- lapply(quantitive_cols, function(var) {
  plot_ly(y = data_new[, var], type = "box", name=var, quartilemethod="exclusive")
})
fig <- subplot(plots, nrows=4, margin=0.05)
fig <- fig %>% layout(legend = list(orientation = 'h'))
fig
```
```{r}
plots <- lapply(quantitive_cols, function(var) {
  plot_ly(x = data_new[, var], name=var)%>%
  add_histogram()
})
fig <- subplot(plots, nrows=4, margin=0.05)
fig <- fig %>% layout(legend = list(orientation = 'h'))
fig
```

```{r}
p1 <- plot_ly(data_new, x = ~Status) %>%
  add_histogram()

p1
```


# Corelation between variables (graphic presentation)
```{r}
correlation_data <- data_new[quantitive_cols]

fig <- plot_ly(
    x = quantitive_cols,
    y = quantitive_cols,
    z = cor(correlation_data), type = "heatmap"
)

fig
```

The above chart gives us important information about the correlation between variables. As we can see, there is almost perfect correlation between thinness.1.19.years and thinness.5.9.years. There also appears to be a very strong correlation between GDP and percentage.expenditure (0.9), as well as infant.deaths and under.five.deaths (0.99). Naturally, we can also see a strong negative correlation between Adult.Mortality and Life.expectancy (-0.69). Schooling and life expectancy seem to be slightly correlated as well (0.71).

For our prediction, we will need to drop some of the features that are highly correlated. We will drop thinness.5.9.years, percentage.expenditure and infant.deaths, as their correlation to our decision variable is weaker than features correlated to them.

# Interavtive plot for average life duration per country with respect to year

The following plot is fully interactive - hover over selected line to see a specific value, select one country by double clicking on it in the legend. In one country view, you can then single click on one country to add it to the plot. If you want to return to the view of all countries - double click on the legend again. 
```{r}

countries <- unique(data_new$Country)
fig <- plot_ly(data, x = data_new[data_new$Country == 'Afghanistan', 'Year'])

for(name in countries){
  fig <- fig %>% add_trace(y = data_new[data_new$Country == name, 'Life.expectancy'], name = name, type = 'scatter', mode = 'lines') 
}

fig <- fig %>% layout(legend = list(orientation = 'h'))


fig
```


# Data preparation
```{r}

regression_data <- data_new[, !names(data_new) %in% c("Country", "thinness.5.9.years", "percentage.expenditure", "infant.deaths", "Year")]


kable(head(regression_data), "html") %>% kable_styling("striped") %>% scroll_box(width = "100%")

```
# Regressor for average life duration estimation

Train test valid split
```{r}

trainval_partition <- 
    createDataPartition(
        y = regression_data$Life.expectancy,
        p = .8,
        list = FALSE)

trainval_data <- regression_data[ trainval_partition,]
test_data  <- regression_data[-trainval_partition,]

train_partition <- 
    createDataPartition(
        y = trainval_data$Life.expectancy,
        p = .8,
        list = FALSE)

train_data <- trainval_data[ train_partition,]
val_data  <- trainval_data[-train_partition,]
```

```{r}
control <- trainControl(
    method = "repeatedcv",
    number = 10,
    repeats = 5)

```


```{r, warning=FALSE}
linear <- train(Life.expectancy ~ .,
               data = train_data,
               trControl = control,
               preProcess = c('scale', 'center'),
               method = "lm")
linear
```

# Model parameter tuning and accuracy calculation using R2 and RMSE measures


```{r, warning=FALSE}
lasso <- train(Life.expectancy ~ .,
               data = train_data,
               trControl = control,
               preProcess = c('scale', 'center'),
               method = "lasso")
lasso
```
```{r, warning=FALSE}
ridge <- train(Life.expectancy ~ .,
               data = train_data,
               trControl = control,
               preProcess = c('scale', 'center'),
               method = "ridge")
ridge
```
# Attribute importance analysis for the best model found

```{r}
ggplot(varImp(ridge))
```

# What attribute contributes the most to longer or shorter life duration?